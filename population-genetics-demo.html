<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Population Genetics Simulator - CodonCanvas</title>
    <link rel="stylesheet" href="css/population-genetics-demo.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸ§¬ Population Genetics Simulator</h1>
        <p>Observe genetic drift and evolutionary divergence in real-time</p>
      </header>

      <div class="content">
        <div class="intro">
          <h2>About This Simulation</h2>
          <p>
            Start with a population of <strong>identical genomes</strong> and
            watch them <strong>diverge</strong>
            through random mutations over generations. This demonstrates
            fundamental concepts in population genetics:
          </p>
          <ul style="margin: 10px 0 10px 30px">
            <li>
              <strong>Genetic Drift:</strong> Random changes in allele
              frequencies between generations
            </li>
            <li>
              <strong>Mutation Accumulation:</strong> How populations accumulate
              genetic differences over time
            </li>
            <li>
              <strong>Divergent Evolution:</strong> How identical ancestors
              produce varied descendants
            </li>
            <li>
              <strong>Fitness Landscapes:</strong> How different mutations
              affect phenotypic outcomes
            </li>
          </ul>
        </div>

        <div class="controls">
          <div class="control-group">
            <label>Founder Genome (all organisms start with this):</label>
            <textarea id="founderGenome">ATG GAA CCC GGA TAA</textarea>
          </div>

          <div class="control-group">
            <label>Population Parameters:</label>
            <div class="control-row">
              <div>
                <label
                  for="popSize"
                  style="font-weight: normal; font-size: 13px"
                >Population Size:</label>
                <input type="number" id="popSize" min="2" max="12" value="6" />
              </div>
              <div>
                <label
                  for="mutationRate"
                  style="font-weight: normal; font-size: 13px"
                >Mutation Rate (%):</label>
                <input
                  type="number"
                  id="mutationRate"
                  min="0"
                  max="100"
                  value="15"
                  step="5"
                />
              </div>
              <div>
                <label
                  for="generationDelay"
                  style="font-weight: normal; font-size: 13px"
                >Generation Delay (ms):</label>
                <input
                  type="number"
                  id="generationDelay"
                  min="100"
                  max="5000"
                  value="1000"
                  step="100"
                />
              </div>
            </div>
          </div>

          <div class="control-group">
            <label>Mutation Type Distribution:</label>
            <div class="control-row">
              <div>
                <label
                  for="mutationType"
                  style="font-weight: normal; font-size: 13px"
                >Type:</label>
                <select id="mutationType">
                  <option value="balanced">Balanced (all types)</option>
                  <option value="point-only">Point mutations only</option>
                  <option value="frameshift-heavy">Frameshift-heavy</option>
                  <option value="conservative">
                    Conservative (70% silent)
                  </option>
                </select>
              </div>
            </div>
          </div>

          <div class="button-group">
            <button id="startBtn">Start Simulation</button>
            <button id="pauseBtn" disabled>Pause</button>
            <button id="resetBtn">Reset Population</button>
            <button id="stepBtn">Single Generation</button>
          </div>
        </div>

        <div class="stats-panel">
          <h2 style="margin-bottom: 15px">Population Statistics</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Current Generation</div>
              <div class="stat-value" id="currentGen">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Mutations</div>
              <div class="stat-value" id="totalMutations">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Genetic Diversity</div>
              <div class="stat-value" id="diversity">0%</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Unique Genomes</div>
              <div class="stat-value" id="uniqueGenomes">1</div>
            </div>
          </div>
        </div>

        <h2 style="margin-bottom: 20px">
          Population (Generation <span id="generationDisplay">0</span>)
        </h2>
        <div class="population-grid" id="populationGrid"></div>

        <div class="info-box">
          <h3>ðŸ’¡ Observation Tips</h3>
          <ul>
            <li>
              <strong>Watch for divergence:</strong> Identical starting genomes
              become visually distinct over generations
            </li>
            <li>
              <strong>Mutation types matter:</strong> Frameshift mutations cause
              dramatic phenotypic changes
            </li>
            <li>
              <strong>Genetic diversity increases:</strong> The "Unique Genomes"
              stat tracks how many distinct variants exist
            </li>
            <li>
              <strong>Some lineages fail:</strong> Nonsense mutations (early
              STOP) produce truncated phenotypes
            </li>
            <li>
              <strong>Try different rates:</strong> High mutation rates
              (&gt;30%) accelerate divergence, low rates (&lt;5%) show drift
            </li>
          </ul>
        </div>
      </div>

      <footer>
        <p>
          <strong>CodonCanvas Population Genetics Simulator</strong><br />
          Explore more demos:
          <a href="index.html">Playground</a> |
          <a href="mutation-demo.html">Mutation Lab</a> |
          <a href="evolution-demo.html">Evolution Lab</a> |
          <a href="timeline-demo.html">Timeline Scrubber</a>
        </p>
      </footer>
    </div>

    <script type="module">
      import { CodonLexer } from "./src/lexer.ts";
import {
  applyDeletion,
  applyFrameshiftMutation,
  applyInsertion,
  applyPointMutation,
} from "./src/mutations.ts";
import { Canvas2DRenderer } from "./src/renderer.ts";
import { CodonVM } from "./src/vm.ts";

// Population state
let population = [];
let generation = 0;
let totalMutations = 0;
let isRunning = false;
let intervalId = null;
let founderGenome = "";

// DOM elements
const founderGenomeInput = document.getElementById("founderGenome");
const popSizeInput = document.getElementById("popSize");
const mutationRateInput = document.getElementById("mutationRate");
const generationDelayInput = document.getElementById("generationDelay");
const mutationTypeSelect = document.getElementById("mutationType");
const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");
const stepBtn = document.getElementById("stepBtn");
const populationGrid = document.getElementById("populationGrid");
const currentGenSpan = document.getElementById("currentGen");
const totalMutationsSpan = document.getElementById("totalMutations");
const diversitySpan = document.getElementById("diversity");
const uniqueGenomesSpan = document.getElementById("uniqueGenomes");
const generationDisplay = document.getElementById("generationDisplay");

// Initialize population
function initializePopulation() {
  const popSize = parseInt(popSizeInput.value, 10);
  founderGenome = founderGenomeInput.value.trim();

  population = Array.from({ length: popSize }, (_, i) => ({
    id: i,
    genome: founderGenome,
    generation: 0,
    mutations: [],
    parentId: null,
  }));

  generation = 0;
  totalMutations = 0;
  renderPopulation();
  updateStats();
}

// Apply mutation based on type distribution
function applyMutation(genome) {
  const mutationType = mutationTypeSelect.value;
  const rand = Math.random();

  let result;
  switch (mutationType) {
    case "point-only":
      result = applyPointMutation(genome);
      break;
    case "frameshift-heavy":
      if (rand < 0.6) {
        result = applyFrameshiftMutation(genome);
      } else if (rand < 0.8) {
        result = applyInsertion(genome);
      } else {
        result = applyPointMutation(genome);
      }
      break;
    case "conservative":
      if (rand < 0.7) {
        // Silent mutation - pick a codon and replace with synonymous
        result = applyPointMutation(genome);
      } else if (rand < 0.9) {
        result = applyPointMutation(genome);
      } else {
        result = applyInsertion(genome);
      }
      break;
    default: // balanced
      if (rand < 0.5) {
        result = applyPointMutation(genome);
      } else if (rand < 0.7) {
        result = applyInsertion(genome);
      } else if (rand < 0.85) {
        result = applyDeletion(genome);
      } else {
        result = applyFrameshiftMutation(genome);
      }
  }

  return result;
}

// Advance one generation
function advanceGeneration() {
  generation++;
  const mutationRate = parseFloat(mutationRateInput.value) / 100;

  population = population.map((organism, _idx) => {
    let newGenome = organism.genome;
    const mutations = [];

    // Apply mutations based on rate
    if (Math.random() < mutationRate) {
      const mutationResult = applyMutation(newGenome);
      newGenome = mutationResult.mutated;
      mutations.push(mutationResult.description);
      totalMutations++;
    }

    return {
      id: organism.id,
      genome: newGenome,
      generation,
      mutations,
      parentId: organism.id,
    };
  });

  renderPopulation();
  updateStats();
}

// Render population grid
function renderPopulation() {
  populationGrid.innerHTML = "";
  generationDisplay.textContent = generation;

  population.forEach((organism, idx) => {
    const card = document.createElement("div");
    card.className = "organism-card";

    const header = document.createElement("div");
    header.className = "organism-header";
    header.innerHTML = `
          <span>Organism ${idx + 1}</span>
          <span class="generation-badge">Gen ${organism.generation}</span>
        `;

    const canvas = document.createElement("canvas");
    canvas.className = "organism-canvas";
    canvas.width = 400;
    canvas.height = 400;

    const genomeDiv = document.createElement("div");
    genomeDiv.className = "organism-genome";

    // Highlight mutations if any
    let genomeDisplay = organism.genome;
    if (organism.mutations.length > 0) {
      genomeDisplay = `<span class="mutation-highlight" title="${organism.mutations.join(
        ", ",
      )}">${organism.genome}</span>`;
      genomeDiv.innerHTML = genomeDisplay;
    } else {
      genomeDiv.textContent = organism.genome;
    }

    card.appendChild(header);
    card.appendChild(canvas);
    card.appendChild(genomeDiv);
    populationGrid.appendChild(card);

    // Render genome on canvas
    try {
      const lexer = new CodonLexer();
      const tokens = lexer.tokenize(organism.genome);
      const renderer = new Canvas2DRenderer(canvas);
      const vm = new CodonVM(renderer);
      vm.run(tokens);
    } catch (error) {
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#ffebee";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#c62828";
      ctx.font = "14px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("Render Error", canvas.width / 2, canvas.height / 2 - 10);
      ctx.font = "11px sans-serif";
      ctx.fillText(
        error.message.substring(0, 40),
        canvas.width / 2,
        canvas.height / 2 + 10,
      );
    }
  });
}

// Update statistics
function updateStats() {
  currentGenSpan.textContent = generation;
  totalMutationsSpan.textContent = totalMutations;

  // Calculate genetic diversity (unique genomes / total)
  const uniqueGenomes = new Set(population.map((org) => org.genome)).size;
  const diversity = ((uniqueGenomes / population.length) * 100).toFixed(0);

  diversitySpan.textContent = `${diversity}%`;
  uniqueGenomesSpan.textContent = uniqueGenomes;
}

// Event handlers
startBtn.addEventListener("click", () => {
  if (!isRunning) {
    isRunning = true;
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    stepBtn.disabled = true;

    const delay = parseInt(generationDelayInput.value, 10);
    intervalId = setInterval(advanceGeneration, delay);
  }
});

pauseBtn.addEventListener("click", () => {
  if (isRunning) {
    isRunning = false;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    stepBtn.disabled = false;
    clearInterval(intervalId);
  }
});

resetBtn.addEventListener("click", () => {
  if (isRunning) {
    clearInterval(intervalId);
    isRunning = false;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
  }
  stepBtn.disabled = false;
  initializePopulation();
});

stepBtn.addEventListener("click", () => {
  advanceGeneration();
});

// Initialize on load
initializePopulation();
    </script>
  </body>
</html>
