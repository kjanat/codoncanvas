<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Tutorial - CodonCanvas</title>
    <style>
    * {
      box-sizing: border-box;
      padding: 0;
      margin: 0;
    }

    body {
      min-height: 100vh;
      padding: 20px;
      font-family:
        -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
        Arial, sans-serif;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .container {
      display: grid;
      grid-template-rows: auto 1fr;
      max-width: 1400px;
      min-height: calc(100vh - 40px);
      margin: 0 auto;
      overflow: hidden;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 32px;
      color: white;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .header h1 {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 28px;
      font-weight: 700;
    }

    .progress-bar {
      flex: 1;
      max-width: 400px;
      height: 8px;
      margin-left: 32px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-left: 12px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0.9;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 0;
      overflow: hidden;
    }

    /* Left Panel - Instructions */
    .instructions-panel {
      display: flex;
      flex-direction: column;
      padding: 32px;
      overflow-y: auto;
      background: #f8f9fa;
      border-right: 2px solid #e9ecef;
    }

    .lesson-header {
      margin-bottom: 24px;
    }

    .module-badge {
      display: inline-block;
      padding: 4px 12px;
      margin-bottom: 12px;
      font-size: 12px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      background: #667eea;
      border-radius: 12px;
    }

    .lesson-title {
      margin-bottom: 8px;
      font-size: 24px;
      font-weight: 700;
      color: #2d3748;
    }

    .lesson-description {
      font-size: 14px;
      line-height: 1.6;
      color: #718096;
    }

    .lesson-content {
      flex: 1;
      margin-bottom: 24px;
    }

    .instruction-list {
      margin-bottom: 20px;
      list-style: none;
    }

    .instruction-list li {
      padding: 12px 16px;
      margin-bottom: 12px;
      font-size: 15px;
      line-height: 1.6;
      color: #4a5568;
      background: white;
      border-left: 4px solid #667eea;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .starter-code-section {
      padding: 16px;
      margin: 20px 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .starter-code-section h4 {
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
    }

    .starter-code {
      padding: 12px;
      overflow-x: auto;
      font-family: "Courier New", monospace;
      font-size: 14px;
      color: #68d391;
      white-space: pre;
      background: #2d3748;
      border-radius: 4px;
    }

    .hints-section {
      margin-top: 20px;
    }

    .hint-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #856404;
      text-align: left;
      cursor: pointer;
      background: #fef3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .hint-toggle:hover {
      background: #ffe9a3;
    }

    .hint-content {
      display: none;
      padding: 16px;
      margin-top: 12px;
      font-size: 14px;
      line-height: 1.6;
      color: #856404;
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
    }

    .hint-content.show {
      display: block;
    }

    .hint-item {
      margin-bottom: 12px;
    }

    .hint-item:last-child {
      margin-bottom: 0;
    }

    .objectives-section {
      padding: 16px;
      margin-top: 20px;
      background: #e6f3ff;
      border-left: 4px solid #0066cc;
      border-radius: 4px;
    }

    .objectives-section h4 {
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: #004080;
    }

    .objectives-section ul {
      font-size: 13px;
      color: #004080;
      list-style: none;
    }

    .objectives-section li::before {
      font-weight: bold;
      color: #0066cc;
      content: "‚úì ";
    }

    /* Right Panel - Editor and Canvas */
    .workspace-panel {
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 32px;
      overflow-y: auto;
    }

    .editor-section, .canvas-section {
      padding: 20px;
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-header {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
    }

    .code-editor {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      font-family: "Courier New", monospace;
      font-size: 16px;
      line-height: 1.8;
      color: #2d3748;
      resize: vertical;
      background: #f7fafc;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    .code-editor:focus {
      outline: none;
      background: white;
      border-color: #667eea;
    }

    .validation-message {
      display: none;
      padding: 12px 16px;
      margin-top: 12px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
    }

    .validation-message.show {
      display: block;
    }

    .validation-message.success {
      color: #155724;
      background: #d4edda;
      border: 2px solid #28a745;
    }

    .validation-message.error {
      color: #721c24;
      background: #f8d7da;
      border: 2px solid #dc3545;
    }

    .validation-errors {
      padding-left: 20px;
      margin-top: 8px;
      font-size: 13px;
    }

    .canvas-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      background: #f7fafc;
      border: 2px solid #e9ecef;
      border-radius: 8px;
    }

    #output-canvas {
      max-width: 100%;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Navigation Controls */
    .nav-controls {
      display: flex;
      gap: 12px;
      padding-top: 24px;
      margin-top: auto;
      border-top: 2px solid #e9ecef;
    }

    .nav-btn {
      display: flex;
      flex: 1;
      gap: 8px;
      align-items: center;
      justify-content: center;
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .nav-btn:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .nav-btn.primary {
      color: white;
      background: #667eea;
    }

    .nav-btn.primary:hover:not(:disabled) {
      background: #5568d3;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transform: translateY(-1px);
    }

    .nav-btn.secondary {
      color: #495057;
      background: #e9ecef;
    }

    .nav-btn.secondary:hover:not(:disabled) {
      background: #dee2e6;
    }

    .nav-btn.validate {
      color: white;
      background: #28a745;
    }

    .nav-btn.validate:hover:not(:disabled) {
      background: #218838;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      transform: translateY(-1px);
    }

    /* Module Selector */
    .module-selector {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 20px;
      background: rgba(0, 0, 0, 0.7);
    }

    .module-selector.hidden {
      display: none;
    }

    .module-grid {
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      padding: 40px;
      overflow-y: auto;
      background: white;
      border-radius: 16px;
    }

    .module-grid h2 {
      margin-bottom: 12px;
      font-size: 32px;
      font-weight: 700;
      color: #2d3748;
      text-align: center;
    }

    .module-grid p {
      margin-bottom: 32px;
      font-size: 16px;
      color: #718096;
      text-align: center;
    }

    .modules {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .module-card {
      position: relative;
      padding: 24px;
      overflow: hidden;
      color: white;
      cursor: pointer;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .module-card:hover {
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
      transform: translateY(-4px);
    }

    .module-card.completed::after {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      font-size: 20px;
      font-weight: bold;
      color: #28a745;
      content: "‚úì";
      background: white;
      border-radius: 50%;
    }

    .module-number {
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0.8;
    }

    .module-title {
      margin-bottom: 8px;
      font-size: 20px;
      font-weight: 700;
    }

    .module-description {
      margin-bottom: 12px;
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.9;
    }

    .module-lessons {
      font-size: 13px;
      opacity: 0.8;
    }

    .exit-tutorial {
      padding-top: 20px;
      text-align: center;
      border-top: 2px solid #e9ecef;
    }

    .exit-btn {
      padding: 12px 32px;
      font-size: 15px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      background: #6c757d;
      border: none;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .exit-btn:hover {
      background: #5a6268;
    }

    /* Completion Badge */
    .completion-badge {
      position: fixed;
      top: 50%;
      left: 50%;
      z-index: 2000;
      max-width: 500px;
      padding: 48px;
      text-align: center;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -50%) scale(0);
      transition: transform 0.3s ease;
    }

    .completion-badge.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .completion-badge h2 {
      margin-bottom: 16px;
      font-size: 36px;
      color: #2d3748;
    }

    .completion-badge p {
      margin-bottom: 24px;
      font-size: 16px;
      line-height: 1.6;
      color: #718096;
    }

    .completion-emoji {
      display: block;
      margin-bottom: 20px;
      font-size: 80px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main-content {
        grid-template-rows: auto 1fr;
        grid-template-columns: 1fr;
      }

      .instructions-panel {
        max-height: 300px;
        border-right: none;
        border-bottom: 2px solid #e9ecef;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .container {
        min-height: 100vh;
        border-radius: 0;
      }

      .header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .progress-bar {
        max-width: 100%;
        margin-left: 0;
      }

      .modules {
        grid-template-columns: 1fr;
      }
    }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>
          <span>üß¨</span>
          <span>CodonCanvas Tutorial</span>
        </h1>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0%</div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Left Panel - Instructions -->
        <div class="instructions-panel">
          <div class="lesson-header">
            <div class="module-badge" id="moduleBadge">MODULE 1</div>
            <h2 class="lesson-title" id="lessonTitle">Loading...</h2>
            <p class="lesson-description" id="lessonDescription"></p>
          </div>

          <div class="lesson-content">
            <ul class="instruction-list" id="instructionList"></ul>

            <div
              class="starter-code-section"
              id="starterCodeSection"
              style="display: none"
            >
              <h4>üéØ Starter Code</h4>
              <pre class="starter-code" id="starterCode"></pre>
            </div>

            <div class="hints-section">
              <button class="hint-toggle" id="hintToggle">
                <span>üí° Need a hint?</span>
                <span id="hintArrow">‚ñº</span>
              </button>
              <div class="hint-content" id="hintContent"></div>
            </div>

            <div class="objectives-section">
              <h4>üìö Learning Objectives</h4>
              <ul id="objectivesList"></ul>
            </div>
          </div>

          <!-- Navigation Controls -->
          <div class="nav-controls">
            <button class="nav-btn secondary" id="prevBtn" disabled>
              <span>‚Üê</span>
              <span>Previous</span>
            </button>
            <button class="nav-btn validate" id="validateBtn">
              <span>‚úì</span>
              <span>Check Answer</span>
            </button>
            <button class="nav-btn primary" id="nextBtn">
              <span>Next</span>
              <span>‚Üí</span>
            </button>
          </div>
        </div>

        <!-- Right Panel - Editor and Canvas -->
        <div class="workspace-panel">
          <!-- Editor -->
          <div class="editor-section">
            <div class="section-header">
              <span>üìù</span>
              <span>Code Editor</span>
            </div>
            <textarea
              class="code-editor"
              id="codeEditor"
              placeholder="Type your CodonCanvas code here..."
            ></textarea>
            <div class="validation-message" id="validationMessage"></div>
          </div>

          <!-- Canvas -->
          <div class="canvas-section">
            <div class="section-header">
              <span>üé®</span>
              <span>Output Canvas</span>
            </div>
            <div class="canvas-container">
              <canvas id="output-canvas" width="400" height="400"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Module Selector Overlay -->
    <div class="module-selector" id="moduleSelector">
      <div class="module-grid">
        <h2>Choose Your Learning Path</h2>
        <p>Select a module to begin or continue your CodonCanvas journey</p>

        <div class="modules" id="modulesGrid"></div>

        <div class="exit-tutorial">
          <button class="exit-btn" onclick="window.location.href='index.html'">
            Exit Tutorial
          </button>
        </div>
      </div>
    </div>

    <!-- Completion Badge -->
    <div class="completion-badge" id="completionBadge">
      <span class="completion-emoji">üèÜ</span>
      <h2>Lesson Complete!</h2>
      <p id="completionMessage"></p>
      <button class="nav-btn primary" onclick="hideCompletionBadge()">
        Continue
      </button>
    </div>

    <script type="module">
    import { CodonLexer } from "./src/lexer.ts";
import { Canvas2DRenderer } from "./src/renderer.ts";
import { CodonVM } from "./src/vm.ts";

// Tutorial Engine implementation
class TutorialEngine {
  constructor() {
    this.lessons = new Map();
    this.progress = this.loadProgress();
    this.initializeLessons();
  }

  initializeLessons() {
    const lessons = [
      // MODULE 1: FIRST STEPS
      {
        id: "basics-1",
        module: 1,
        lessonNumber: 1,
        title: "Hello Circle - Your First Program",
        description:
          "Learn the basic structure of a CodonCanvas program by drawing a simple circle.",
        instructions: [
          "Every program starts with ATG (START codon)",
          "Use GAA to PUSH a number onto the stack",
          "The next codon after PUSH is read as a number (0-63)",
          "Use GGA to draw a CIRCLE with the radius from the stack",
          "End with TAA (STOP codon)",
        ],
        starterCode: "ATG\\n\\n\\nTAA",
        hints: [
          "Try: ATG GAA CCC GGA TAA",
          "CCC encodes the number 21 (C=1, C=1, C=1 ‚Üí 1√ó16 + 1√ó4 + 1 = 21)",
          "The circle will appear at the center with radius proportional to the number",
        ],
        validation: {
          type: "both",
          requiredCodons: ["ATG", "GAA", "GGA", "TAA"],
          minInstructions: 4,
        },
        learningObjectives: [
          "Understand START (ATG) and STOP (TAA) codons",
          "Learn to PUSH numeric values",
          "Draw basic shapes with CIRCLE",
        ],
        nextLesson: "basics-2",
      },
      {
        id: "basics-2",
        module: 1,
        lessonNumber: 2,
        title: "Moving Around - TRANSLATE",
        description:
          "Learn to move the drawing position to create compositions.",
        instructions: [
          "ACA is the TRANSLATE codon - it moves the drawing position",
          "TRANSLATE needs TWO numbers: dx (horizontal) and dy (vertical)",
          "Push two numbers, then use ACA to move",
          "Draw multiple shapes at different positions",
        ],
        starterCode: "ATG\\nGAA AAT GGA\\n\\n\\nTAA",
        hints: [
          "Add: GAA CCC GAA AAA ACA before the final TAA",
          "This pushes 21 for dx, 0 for dy, then translates",
          "Now add another PUSH and CIRCLE to draw at the new position",
        ],
        validation: {
          type: "both",
          requiredCodons: ["ATG", "ACA", "TAA"],
          minInstructions: 8,
        },
        learningObjectives: [
          "Use TRANSLATE to move drawing position",
          "Understand stack order (dy on top, dx below)",
          "Create multi-shape compositions",
        ],
        nextLesson: "basics-3",
      },
      {
        id: "basics-3",
        module: 1,
        lessonNumber: 3,
        title: "Adding Color - HSL Values",
        description: "Make your drawings colorful with the COLOR opcode.",
        instructions: [
          "TTA is the COLOR codon",
          "COLOR needs THREE numbers: Hue (0-360), Saturation (0-100), Lightness (0-100)",
          "For CodonCanvas, values are 0-63, scaled automatically",
          "Push three values, then use TTA to set color",
        ],
        starterCode: "ATG\\nGAA AAT GGA\\nTAA",
        hints: [
          "Insert before GGA: GAA TCC GAA CCC GAA CCC TTA",
          "This sets color: H‚âà53, S‚âà21, L‚âà21 (dark reddish)",
          "Try different values to explore the color space",
        ],
        validation: {
          type: "code",
          requiredCodons: ["TTA"],
          minInstructions: 7,
        },
        learningObjectives: [
          "Understand HSL color model",
          "Use COLOR opcode with three stack values",
          "Experiment with color values",
        ],
        nextLesson: "mutations-1",
      },

      // MODULE 2: MUTATIONS
      {
        id: "mutations-1",
        module: 2,
        lessonNumber: 1,
        title: "Silent Mutations - Same Output",
        description:
          "Discover synonymous codons that produce identical results.",
        instructions: [
          "Many codons map to the SAME opcode (like real genetic code)",
          "GGA, GGC, GGG, GGT all produce CIRCLE",
          "Change one of these to another - the output stays the same",
          "This demonstrates genetic redundancy",
        ],
        starterCode: "ATG\\nGAA AAT GGA\\nTAA",
        hints: [
          "Try changing GGA to GGC",
          "Or change it to GGG or GGT",
          "All four are synonymous - they all mean CIRCLE",
        ],
        validation: {
          type: "code",
          requiredCodons: ["ATG", "TAA"],
          customValidator: (code) => {
            const circleCount = (code.match(/GG[ACGT]/g) || []).length;
            return circleCount >= 1;
          },
        },
        learningObjectives: [
          "Understand codon redundancy",
          "Identify synonymous codons",
          "See that mutations can be neutral",
        ],
        nextLesson: "mutations-2",
      },
      {
        id: "mutations-2",
        module: 2,
        lessonNumber: 2,
        title: "Missense Mutations - Different Shape",
        description:
          "Change the function by switching to a different opcode family.",
        instructions: [
          "Changing to a DIFFERENT codon family creates a missense mutation",
          "GGA (CIRCLE) ‚Üí CCA (RECT) changes the shape",
          "RECT needs TWO values (width, height), so add another PUSH",
          "Observe how the phenotype changes dramatically",
        ],
        starterCode: "ATG\\nGAA AAT GGA\\nTAA",
        hints: [
          "Change GGA to CCA (CIRCLE ‚Üí RECT)",
          "Add another GAA AAT before CCA for the second dimension",
          "Now you have: GAA AAT GAA AAT CCA",
        ],
        validation: {
          type: "code",
          requiredCodons: ["CCA", "CCG", "CCC", "CCT"],
          minInstructions: 6,
        },
        learningObjectives: [
          "Understand missense mutations",
          "See how changing opcode changes phenotype",
          "Adapt code to new opcode requirements",
        ],
        nextLesson: "mutations-3",
      },
      {
        id: "mutations-3",
        module: 2,
        lessonNumber: 3,
        title: "Nonsense Mutations - Early Stop",
        description: "Insert a STOP codon early to truncate the program.",
        instructions: [
          "TAA, TAG, TGA are all STOP codons",
          "Inserting STOP early creates a nonsense mutation",
          "The program terminates before drawing everything",
          "This mimics premature termination in protein synthesis",
        ],
        starterCode:
          "ATG\\nGAA AAT GGA\\nGAA CCC GAA AAA ACA\\nGAA AGG GGA\\nTAA",
        hints: [
          "Insert TAA or TAG after the first GGA",
          "The second circle will disappear",
          "Try removing the early STOP to restore full output",
        ],
        validation: {
          type: "code",
          customValidator: (code) => {
            const stops = (code.match(/TAA|TAG|TGA/g) || []).length;
            return stops >= 2;
          },
        },
        learningObjectives: [
          "Understand nonsense mutations",
          "See truncation effects",
          "Recognize all three STOP codons",
        ],
        nextLesson: "mutations-4",
      },
      {
        id: "mutations-4",
        module: 2,
        lessonNumber: 4,
        title: "Frameshift - Reading Frame Chaos",
        description:
          "Insert or delete bases to shift the reading frame downstream.",
        instructions: [
          "Inserting/deleting 1-2 bases shifts the reading frame",
          "All downstream codons are reinterpreted",
          "GAA AGG ‚Üí GA AAG G... (if you delete one A)",
          "This creates dramatic, unpredictable changes",
        ],
        starterCode:
          "ATG\\nGAA AAT GGA\\nGAA CCC GAA AAA ACA\\nGAA AGG GGA\\nTAA",
        hints: [
          "Delete one A from GAA to make GA",
          "Or insert an extra C anywhere in the middle",
          "Watch the whole downstream sequence scramble",
        ],
        validation: {
          type: "code",
          customValidator: (code) => {
            const cleaned = code.replace(/\\s+/g, "");
            return cleaned.length % 3 !== 0;
          },
        },
        learningObjectives: [
          "Understand frameshift mutations",
          "See global effects of local changes",
          "Appreciate reading frame importance",
        ],
        nextLesson: "advanced-1",
      },

      // MODULE 3: ADVANCED TECHNIQUES
      {
        id: "advanced-1",
        module: 3,
        lessonNumber: 1,
        title: "Stack Magic - DUP and SWAP",
        description: "Use stack operations to reuse values efficiently.",
        instructions: [
          "ATA is DUP - duplicates the top stack value",
          "TGG is SWAP - swaps the top two values",
          "Use DUP to draw multiple shapes with the same size",
          "Use SWAP to reorder values without pushing again",
        ],
        starterCode: "ATG\\nGAA AGG\\n\\nTAA",
        hints: [
          "Add ATA after GAA AGG to duplicate the value",
          "Now you have [10, 10] on the stack",
          "Add GGA to draw a circle with radius 10",
          "The duplicate is still there - add another GGA",
        ],
        validation: {
          type: "code",
          requiredCodons: ["ATA", "ATC", "ATT"],
        },
        learningObjectives: [
          "Master stack manipulation",
          "Use DUP for efficiency",
          "Understand stack-based programming",
        ],
        nextLesson: "advanced-2",
      },
      {
        id: "advanced-2",
        module: 3,
        lessonNumber: 2,
        title: "Rotation and Scale",
        description: "Transform your drawings with rotation and scaling.",
        instructions: [
          "AGA is ROTATE - rotates drawing direction in degrees",
          "CGA is SCALE - scales subsequent drawing operations",
          "Combine with TRANSLATE for complex compositions",
          "Create patterns with repeated transformations",
        ],
        starterCode: "ATG\\nGAA AAT GGA\\nTAA",
        hints: [
          "Add: GAA GCC AGA (rotate by 37 degrees)",
          "Add: GAA CCC GAA AAA ACA (translate)",
          "Add: GAA AAT GGA (draw another circle)",
        ],
        validation: {
          type: "code",
          requiredCodons: ["AGA", "AGC", "AGG", "AGT"],
          minInstructions: 8,
        },
        learningObjectives: [
          "Use ROTATE to change drawing direction",
          "Apply SCALE for size transformations",
          "Combine transforms for complex effects",
        ],
        nextLesson: "advanced-3",
      },
      {
        id: "advanced-3",
        module: 3,
        lessonNumber: 3,
        title: "Creative Challenge - Make Art!",
        description:
          "Apply everything you have learned to create your own design.",
        instructions: [
          "Use any combination of opcodes you have learned",
          "Create a design with at least 3 different shapes",
          "Use at least 2 colors",
          "Use transforms (TRANSLATE, ROTATE, or SCALE)",
          "Be creative - there are no wrong answers!",
        ],
        starterCode: "ATG\\n\\n\\n\\n\\nTAA",
        hints: [
          "Start with a plan: what shapes and where?",
          "Use comments (;) to organize your code sections",
          "Try creating: a flower, a face, a pattern, or abstract art",
        ],
        validation: {
          type: "code",
          minInstructions: 15,
          customValidator: (code) => {
            const hasMultipleShapes =
              (code.match(/GG[ACGT]|CC[ACGT]|AA[ACGT]|GC[ACGT]/g) || [])
                .length >= 3;
            const hasColor = /TT[ACGT]/.test(code);
            const hasTransform = /AC[ACGT]|AG[ACGT]|CG[ACGT]/.test(code);
            return hasMultipleShapes && hasColor && hasTransform;
          },
        },
        learningObjectives: [
          "Apply all learned concepts creatively",
          "Plan and structure complex programs",
          "Express creativity through code",
        ],
        nextLesson: undefined,
      },
    ];

    for (const lesson of lessons) {
      this.lessons.set(lesson.id, lesson);
    }
  }

  loadProgress() {
    const saved = localStorage.getItem("codoncanvas-tutorial-progress");
    if (saved) {
      return JSON.parse(saved);
    }
    return {
      completedLessons: [],
      currentLesson: "basics-1",
      hintsUsed: {},
      attempts: {},
      startedAt: Date.now(),
      lastActivity: Date.now(),
    };
  }

  saveProgress() {
    this.progress.lastActivity = Date.now();
    localStorage.setItem(
      "codoncanvas-tutorial-progress",
      JSON.stringify(this.progress),
    );
  }

  getLesson(id) {
    return this.lessons.get(id);
  }

  getCurrentLesson() {
    return (
      this.lessons.get(this.progress.currentLesson) ||
      this.lessons.get("basics-1")
    );
  }

  getAllLessons() {
    return Array.from(this.lessons.values()).sort((a, b) => {
      if (a.module !== b.module) return a.module - b.module;
      return a.lessonNumber - b.lessonNumber;
    });
  }

  getLessonsByModule(module) {
    return this.getAllLessons().filter((l) => l.module === module);
  }

  setCurrentLesson(id) {
    if (this.lessons.has(id)) {
      this.progress.currentLesson = id;
      this.saveProgress();
    }
  }

  validateLesson(lessonId, code, canvas) {
    const lesson = this.lessons.get(lessonId);
    if (!lesson) {
      return { passed: false, errors: ["Lesson not found"], hints: [] };
    }

    const errors = [];
    const hints = [];

    this.progress.attempts[lessonId] =
      (this.progress.attempts[lessonId] || 0) + 1;

    try {
      const lexer = new CodonLexer();
      const tokens = lexer.tokenize(code);

      if (lesson.validation.requiredCodons) {
        const codeUpper = code.toUpperCase().replace(/\\s+/g, " ");
        for (const required of lesson.validation.requiredCodons) {
          if (!codeUpper.includes(required)) {
            errors.push(`Missing required codon: ${required}`);
          }
        }
      }

      if (
        lesson.validation.minInstructions &&
        tokens.length < lesson.validation.minInstructions
      ) {
        errors.push(
          `Too few instructions (need at least ${lesson.validation.minInstructions})`,
        );
        hints.push("Try adding more operations to complete the task");
      }

      if (lesson.validation.customValidator) {
        if (!lesson.validation.customValidator(code, canvas)) {
          errors.push("Custom validation failed - check the requirements");
        }
      }
    } catch (error) {
      errors.push(
        `Parse error: ${
          error instanceof Error ? error.message : "Unknown error"
        }`,
      );
    }

    const passed = errors.length === 0;

    if (passed && !this.progress.completedLessons.includes(lessonId)) {
      this.markComplete(lessonId);
    }

    return { passed, errors, hints };
  }

  markComplete(lessonId) {
    if (!this.progress.completedLessons.includes(lessonId)) {
      this.progress.completedLessons.push(lessonId);

      const lesson = this.lessons.get(lessonId);
      if (lesson?.nextLesson) {
        this.progress.currentLesson = lesson.nextLesson;
      }

      this.saveProgress();
    }
  }

  useHint(lessonId) {
    this.progress.hintsUsed[lessonId] =
      (this.progress.hintsUsed[lessonId] || 0) + 1;
    this.saveProgress();
  }

  getProgress() {
    return { ...this.progress };
  }

  getCompletionPercentage() {
    return Math.round(
      (this.progress.completedLessons.length / this.lessons.size) * 100,
    );
  }
}

// Initialize
const tutorial = new TutorialEngine();
const lexer = new CodonLexer();
let currentLesson = tutorial.getCurrentLesson();
let vm = null;
let renderer = null;

// DOM Elements
const codeEditor = document.getElementById("codeEditor");
const canvas = document.getElementById("output-canvas");
const moduleBadge = document.getElementById("moduleBadge");
const lessonTitle = document.getElementById("lessonTitle");
const lessonDescription = document.getElementById("lessonDescription");
const instructionList = document.getElementById("instructionList");
const starterCodeSection = document.getElementById("starterCodeSection");
const starterCode = document.getElementById("starterCode");
const hintToggle = document.getElementById("hintToggle");
const hintContent = document.getElementById("hintContent");
const hintArrow = document.getElementById("hintArrow");
const objectivesList = document.getElementById("objectivesList");
const validationMessage = document.getElementById("validationMessage");
const progressFill = document.getElementById("progressFill");
const progressText = document.getElementById("progressText");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const validateBtn = document.getElementById("validateBtn");
const moduleSelector = document.getElementById("moduleSelector");
const modulesGrid = document.getElementById("modulesGrid");
const completionBadge = document.getElementById("completionBadge");
const completionMessage = document.getElementById("completionMessage");

// Initialize renderer
renderer = new Canvas2DRenderer(canvas);
vm = new CodonVM(renderer);

// Load lesson
function loadLesson(lesson) {
  currentLesson = lesson;

  // Update header
  moduleBadge.textContent = `MODULE ${lesson.module}`;
  lessonTitle.textContent = lesson.title;
  lessonDescription.textContent = lesson.description;

  // Instructions
  instructionList.innerHTML = "";
  lesson.instructions.forEach((instruction) => {
    const li = document.createElement("li");
    li.textContent = instruction;
    instructionList.appendChild(li);
  });

  // Starter code
  if (lesson.starterCode) {
    starterCodeSection.style.display = "block";
    starterCode.textContent = lesson.starterCode;
    codeEditor.value = lesson.starterCode;
  } else {
    starterCodeSection.style.display = "none";
    codeEditor.value = "";
  }

  // Hints
  hintContent.innerHTML = "";
  lesson.hints.forEach((hint) => {
    const div = document.createElement("div");
    div.className = "hint-item";
    div.textContent = hint;
    hintContent.appendChild(div);
  });

  // Objectives
  objectivesList.innerHTML = "";
  lesson.learningObjectives.forEach((obj) => {
    const li = document.createElement("li");
    li.textContent = obj;
    objectivesList.appendChild(li);
  });

  // Reset hints
  hintContent.classList.remove("show");
  hintArrow.textContent = "‚ñº";

  // Clear validation
  validationMessage.classList.remove("show", "success", "error");

  // Update progress
  updateProgress();

  // Run initial code
  runCode();

  // Update navigation
  updateNavigation();
}

// Run code
function runCode() {
  const code = codeEditor.value;

  try {
    const tokens = lexer.tokenize(code);
    vm.reset();
    renderer.clear();
    vm.run(tokens);
  } catch (error) {
    console.warn("Execution error:", error);
  }
}

// Validate lesson
function validateLesson() {
  const code = codeEditor.value;
  const result = tutorial.validateLesson(currentLesson.id, code, canvas);

  validationMessage.classList.add("show");

  if (result.passed) {
    validationMessage.className = "validation-message show success";
    validationMessage.innerHTML = `
          <div><strong>‚úì Excellent work!</strong> You've completed this lesson.</div>
        `;

    // Show completion badge
    const progress = tutorial.getProgress();
    const completedCount = progress.completedLessons.length;
    const totalLessons = tutorial.getAllLessons().length;

    if (completedCount === totalLessons) {
      completionMessage.textContent = `You've completed all ${totalLessons} lessons! You're now a CodonCanvas expert! üéâ`;
    } else {
      completionMessage.textContent = `Great job! You've completed ${completedCount} of ${totalLessons} lessons. Keep going!`;
    }

    completionBadge.classList.add("show");

    updateProgress();
    updateNavigation();
  } else {
    validationMessage.className = "validation-message show error";
    let errorsHTML =
      "<div><strong>‚úó Not quite right.</strong> Here's what needs attention:</div>";

    if (result.errors.length > 0) {
      errorsHTML += '<ul class="validation-errors">';
      result.errors.forEach((error) => {
        errorsHTML += `<li>${error}</li>`;
      });
      errorsHTML += "</ul>";
    }

    if (result.hints.length > 0) {
      errorsHTML +=
        '<div style="margin-top: 8px;"><em>Hint: ' +
        result.hints[0] +
        "</em></div>";
    }

    validationMessage.innerHTML = errorsHTML;
  }
}

// Navigation
function nextLesson() {
  const lesson = currentLesson;
  if (lesson.nextLesson) {
    const next = tutorial.getLesson(lesson.nextLesson);
    if (next) {
      tutorial.setCurrentLesson(next.id);
      loadLesson(next);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  } else {
    // Module complete - show selector
    showModuleSelector();
  }
}

function previousLesson() {
  const allLessons = tutorial.getAllLessons();
  const currentIndex = allLessons.findIndex((l) => l.id === currentLesson.id);

  if (currentIndex > 0) {
    const prev = allLessons[currentIndex - 1];
    tutorial.setCurrentLesson(prev.id);
    loadLesson(prev);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
}

function updateNavigation() {
  const allLessons = tutorial.getAllLessons();
  const currentIndex = allLessons.findIndex((l) => l.id === currentLesson.id);
  const progress = tutorial.getProgress();
  const isCompleted = progress.completedLessons.includes(currentLesson.id);

  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = !isCompleted && !currentLesson.nextLesson;

  if (!currentLesson.nextLesson) {
    nextBtn.innerHTML = "<span>üè†</span><span>Choose Module</span>";
  } else {
    nextBtn.innerHTML = "<span>Next</span><span>‚Üí</span>";
  }
}

// Progress
function updateProgress() {
  const percent = tutorial.getCompletionPercentage();
  progressFill.style.width = `${percent}%`;
  progressText.textContent = `${percent}%`;
}

// Module Selector
function showModuleSelector() {
  const modules = [
    {
      number: 1,
      title: "First Steps",
      description: "Learn the basics of CodonCanvas",
      lessons: 3,
    },
    {
      number: 2,
      title: "Mutations",
      description: "Explore genetic mutation types",
      lessons: 4,
    },
    {
      number: 3,
      title: "Advanced Techniques",
      description: "Master complex compositions",
      lessons: 3,
    },
  ];

  modulesGrid.innerHTML = "";
  const progress = tutorial.getProgress();

  modules.forEach((module) => {
    const moduleLessons = tutorial.getLessonsByModule(module.number);
    const completedInModule = moduleLessons.filter((l) =>
      progress.completedLessons.includes(l.id),
    ).length;
    const isCompleted = completedInModule === moduleLessons.length;

    const card = document.createElement("div");
    card.className = `module-card${isCompleted ? " completed" : ""}`;
    card.innerHTML = `
          <div class="module-number">Module ${module.number}</div>
          <div class="module-title">${module.title}</div>
          <div class="module-description">${module.description}</div>
          <div class="module-lessons">${completedInModule}/${module.lessons} lessons completed</div>
        `;

    card.onclick = () => {
      const firstLesson = moduleLessons[0];
      tutorial.setCurrentLesson(firstLesson.id);
      loadLesson(firstLesson);
      moduleSelector.classList.add("hidden");
    };

    modulesGrid.appendChild(card);
  });

  moduleSelector.classList.remove("hidden");
}

window.hideCompletionBadge = () => {
  completionBadge.classList.remove("show");
};

// Event listeners
codeEditor.addEventListener("input", () => {
  setTimeout(runCode, 300);
});

hintToggle.addEventListener("click", () => {
  const isShown = hintContent.classList.toggle("show");
  hintArrow.textContent = isShown ? "‚ñ≤" : "‚ñº";

  if (isShown) {
    tutorial.useHint(currentLesson.id);
  }
});

validateBtn.addEventListener("click", validateLesson);
prevBtn.addEventListener("click", previousLesson);
nextBtn.addEventListener("click", nextLesson);

// Initialize - show module selector first
updateProgress();
showModuleSelector();

// If there's a current lesson loaded, hide selector
if (
  tutorial.getProgress().completedLessons.length > 0 ||
  (tutorial.getProgress().attempts &&
    Object.keys(tutorial.getProgress().attempts).length > 0)
) {
  loadLesson(currentLesson);
  moduleSelector.classList.add("hidden");
}
    </script>
  </body>
</html>
